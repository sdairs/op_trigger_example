var We=Object.defineProperty,$e=Object.defineProperties;var Je=Object.getOwnPropertyDescriptors;var ee=Object.getOwnPropertySymbols;var Ae=Object.prototype.hasOwnProperty,Re=Object.prototype.propertyIsEnumerable;var Pe=s=>{throw TypeError(s)};var Te=(s,e,t)=>e in s?We(s,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[e]=t,T=(s,e)=>{for(var t in e||(e={}))Ae.call(e,t)&&Te(s,t,e[t]);if(ee)for(var t of ee(e))Re.call(e,t)&&Te(s,t,e[t]);return s},te=(s,e)=>$e(s,Je(e));var ye=(s,e)=>{var t={};for(var r in s)Ae.call(s,r)&&e.indexOf(r)<0&&(t[r]=s[r]);if(s!=null&&ee)for(var r of ee(s))e.indexOf(r)<0&&Re.call(s,r)&&(t[r]=s[r]);return t};var de=(s,e,t)=>e.has(s)||Pe("Cannot "+t);var n=(s,e,t)=>(de(s,e,"read from private field"),t?t.call(s):e.get(s)),u=(s,e,t)=>e.has(s)?Pe("Cannot add the same private member more than once"):e instanceof WeakSet?e.add(s):e.set(s,t),l=(s,e,t,r)=>(de(s,e,"write to private field"),r?r.call(s,t):e.set(s,t),t),p=(s,e,t)=>(de(s,e,"access private method"),t);var y=(s,e,t)=>new Promise((r,i)=>{var o=c=>{try{h(t.next(c))}catch(f){i(f)}},a=c=>{try{h(t.throw(c))}catch(f){i(f)}},h=c=>c.done?r(c.value):Promise.resolve(c.value).then(o,a);h((t=t.apply(s,e)).next())});var se=s=>Number(s),Ke=s=>s==="true"||s==="t",ze=s=>BigInt(s),we=s=>JSON.parse(s),Xe=s=>s,Ze={int2:se,int4:se,int8:ze,bool:Ke,float4:se,float8:se,json:we,jsonb:we};function et(s,e){let t=0,r=null,i="",o=!1,a=0,h;function c(f){let d=[];for(;t<f.length;t++){if(r=f[t],o)r==="\\"?i+=f[++t]:r==='"'?(d.push(e?e(i):i),i="",o=f[t+1]==='"',a=t+2):i+=r;else if(r==='"')o=!0;else if(r==="{")a=++t,d.push(c(f));else if(r==="}"){o=!1,a<t&&d.push(e?e(f.slice(a,t)):f.slice(a,t)),a=t+1;break}else r===","&&h!=="}"&&h!=='"'&&(d.push(e?e(f.slice(a,t)):f.slice(a,t)),a=t+1);h=r}return a<t&&d.push(e?e(f.slice(a,t+1)):f.slice(a,t+1)),d}return c(s)[0]}var re=class{constructor(e){this.parser=T(T({},Ze),e)}parse(e,t){return JSON.parse(e,(r,i)=>{if(r==="value"&&typeof i=="object"&&i!==null){let o=i;Object.keys(o).forEach(a=>{o[a]=this.parseRow(a,o[a],t)})}return i})}parseRow(e,t,r){var M;let i=r[e];if(!i)return t;let d=i,{type:o,dims:a}=d,h=ye(d,["type","dims"]),c=(M=this.parser[o])!=null?M:Xe,f=_e(c,i,e);return a&&a>0?_e((E,q)=>et(E,f),i,e)(t):f(t,h)}};function _e(s,e,t){var i;let r=!((i=e.not_null)!=null&&i);return o=>{if(tt(o)){if(!r)throw new Error(`Column ${t!=null?t:"unknown"} is not nullable`);return null}return s(o,e)}}function tt(s){return s===null||s==="NULL"}function ne(s){return"key"in s}function oe(s){return!ne(s)}function Se(s){return oe(s)&&s.headers.control==="up-to-date"}var R=class s extends Error{constructor(t,r,i,o,a,h){super(h||`HTTP Error ${t} at ${a}: ${r!=null?r:JSON.stringify(i)}`);this.url=a;this.name="FetchError",this.status=t,this.text=r,this.json=i,this.headers=o}static fromResponse(t,r){return y(this,null,function*(){let i=t.status,o=Object.fromEntries([...t.headers.entries()]),a,h,c=t.headers.get("content-type");return c&&c.includes("application/json")?h=yield t.json():a=yield t.text(),new s(i,a,h,o,r)})}},B=class extends Error{constructor(){super("Fetch with backoff aborted")}};var xe="electric-cursor",G="electric-handle",ie="electric-offset",Me="electric-schema",Ce="electric-up-to-date",Ue="database_id",ke="columns",De="cursor",ae="handle",ce="live",le="offset",He="table",ve="where",Oe="replica";var st=[429],ue={initialDelay:100,maxDelay:1e4,multiplier:1.3};function Fe(s,e=ue){let{initialDelay:t,maxDelay:r,multiplier:i,debug:o=!1,onFailedAttempt:a}=e;return(...h)=>y(this,null,function*(){var N;let c=h[0],f=h[1],d=t,M=0;for(;;)try{let E=yield s(...h);if(E.ok)return E;throw yield R.fromResponse(E,c.toString())}catch(E){if(a==null||a(),(N=f==null?void 0:f.signal)!=null&&N.aborted)throw new B;if(E instanceof R&&!st.includes(E.status)&&E.status>=400&&E.status<500)throw E;yield new Promise(q=>setTimeout(q,d)),d=Math.min(d*i,r),o&&(M++,console.log(`Retry attempt #${M} after ${d}ms`))}})}var rt={maxChunksToPrefetch:2};function Ie(s,e=rt){let{maxChunksToPrefetch:t}=e,r;return(...o)=>y(this,null,function*(){let a=o[0].toString(),h=r==null?void 0:r.consume(...o);if(h)return h;r==null||r.abort();let c=yield s(...o),f=be(a,c);return f&&(r=new pe({fetchClient:s,maxPrefetchedRequests:t,url:f,requestInit:o[1]})),c})}var W,$,w,O,_,Y,he,pe=class{constructor(e){u(this,Y);u(this,W);u(this,$);u(this,w,new Map);u(this,O);u(this,_);var t;l(this,W,(t=e.fetchClient)!=null?t:(...r)=>fetch(...r)),l(this,$,e.maxPrefetchedRequests),l(this,O,e.url.toString()),l(this,_,n(this,O)),p(this,Y,he).call(this,e.url,e.requestInit)}abort(){n(this,w).forEach(([e,t])=>t.abort())}consume(...e){var i;let t=e[0].toString(),r=(i=n(this,w).get(t))==null?void 0:i[0];if(!(!r||t!==n(this,O)))return n(this,w).delete(t),r.then(o=>{let a=be(t,o);l(this,O,a),n(this,_)&&!n(this,w).has(n(this,_))&&p(this,Y,he).call(this,n(this,_),e[1])}).catch(()=>{}),r}};W=new WeakMap,$=new WeakMap,w=new WeakMap,O=new WeakMap,_=new WeakMap,Y=new WeakSet,he=function(...e){var i,o;let t=e[0].toString();if(n(this,w).size>=n(this,$))return;let r=new AbortController;try{let a=n(this,W).call(this,t,te(T({},(i=e[1])!=null?i:{}),{signal:nt(r,(o=e[1])==null?void 0:o.signal)}));n(this,w).set(t,[a,r]),a.then(h=>{if(!h.ok||r.signal.aborted)return;let c=be(t,h);if(!c||c===t){l(this,_,void 0);return}return l(this,_,c),p(this,Y,he).call(this,c,e[1])}).catch(()=>{})}catch(a){}};function be(s,e){let t=e.headers.get(G),r=e.headers.get(ie),i=e.headers.has(Ce);if(!t||!r||i)return;let o=new URL(s);if(!o.searchParams.has(ce))return o.searchParams.set(ae,t),o.searchParams.set(le,r),o.toString()}function nt(s,e){return e&&(e.aborted?s.abort():e.addEventListener("abort",()=>s.abort(),{once:!0})),s.signal}var K,z,C,U,F,I,k,A,D,S,V,L,X,Q,m,Ee,Ne,Be,Ye,Ve,J=class J{constructor(e){u(this,m);u(this,K);u(this,z);u(this,C,new Map);u(this,U,new Map);u(this,F);u(this,I);u(this,k);u(this,A,!1);u(this,D,!1);u(this,S);u(this,V);u(this,L);u(this,X);u(this,Q);var i,o,a;ot(e),this.options=T({subscribe:!0},e),l(this,F,(i=this.options.offset)!=null?i:"-1"),l(this,I,""),l(this,S,this.options.shapeHandle),l(this,V,this.options.databaseId),l(this,z,new re(e.parser)),l(this,Q,this.options.replica);let t=(o=e.fetchClient)!=null?o:(...h)=>fetch(...h),r=Fe(t,te(T({},(a=e.backoffOptions)!=null?a:ue),{onFailedAttempt:()=>{var h,c;l(this,D,!1),(c=(h=e.backoffOptions)==null?void 0:h.onFailedAttempt)==null||c.call(h)}}));l(this,K,Ie(r)),this.start()}get shapeHandle(){return n(this,S)}get isUpToDate(){return n(this,A)}get error(){return n(this,X)}start(){return y(this,null,function*(){var a,h;l(this,A,!1);let{url:e,table:t,where:r,columns:i,signal:o}=this.options;try{for(;!(o!=null&&o.aborted)&&!n(this,A)||this.options.subscribe;){let c=new URL(e);t&&c.searchParams.set(He,t),r&&c.searchParams.set(ve,r),i&&i.length>0&&c.searchParams.set(ke,i.join(",")),c.searchParams.set(le,n(this,F)),n(this,A)&&(c.searchParams.set(ce,"true"),c.searchParams.set(De,n(this,I))),n(this,S)&&c.searchParams.set(ae,n(this,S)),n(this,V)&&c.searchParams.set(Ue,n(this,V)),((a=n(this,Q))!=null?a:J.Replica.DEFAULT)!=J.Replica.DEFAULT&&c.searchParams.set(Oe,n(this,Q));let f;try{f=yield n(this,K).call(this,c.toString(),{signal:o,headers:this.options.headers}),l(this,D,!0)}catch(b){if(b instanceof B)break;if(!(b instanceof R))throw b;if(b.status==409){let fe=b.headers[G];p(this,m,Ve).call(this,fe),yield p(this,m,Ee).call(this,b.json);continue}else if(b.status>=400&&b.status<500)throw p(this,m,Ye).call(this,b),p(this,m,Ne).call(this,b),b}let{headers:d,status:M}=f,N=d.get(G);N&&l(this,S,N);let E=d.get(ie);E&&l(this,F,E);let q=d.get(xe);q&&l(this,I,q);let qe=()=>{let b=d.get(Me);return b?JSON.parse(b):{}};l(this,L,(h=n(this,L))!=null?h:qe());let Ge=M===204?"[]":yield f.text();M===204&&l(this,k,Date.now());let Z=n(this,z).parse(Ge,n(this,L));if(Z.length>0){let b=n(this,A),fe=Z[Z.length-1];Se(fe)&&(l(this,k,Date.now()),l(this,A,!0)),yield p(this,m,Ee).call(this,Z),!b&&n(this,A)&&p(this,m,Be).call(this)}}}catch(c){l(this,X,c)}finally{l(this,D,!1)}})}subscribe(e,t){let r=Math.random();return n(this,C).set(r,[e,t]),()=>{n(this,C).delete(r)}}unsubscribeAll(){n(this,C).clear()}subscribeOnceToUpToDate(e,t){let r=Math.random();return n(this,U).set(r,[e,t]),()=>{n(this,U).delete(r)}}unsubscribeAllUpToDateSubscribers(){n(this,U).clear()}lastSyncedAt(){return n(this,k)}lastSynced(){return n(this,k)===void 0?1/0:Date.now()-n(this,k)}isConnected(){return n(this,D)}isLoading(){return!this.isUpToDate}};K=new WeakMap,z=new WeakMap,C=new WeakMap,U=new WeakMap,F=new WeakMap,I=new WeakMap,k=new WeakMap,A=new WeakMap,D=new WeakMap,S=new WeakMap,V=new WeakMap,L=new WeakMap,X=new WeakMap,Q=new WeakMap,m=new WeakSet,Ee=function(e){return y(this,null,function*(){yield Promise.all(Array.from(n(this,C).values()).map(i=>y(this,[i],function*([t,r]){try{yield t(e)}catch(o){queueMicrotask(()=>{throw o})}})))})},Ne=function(e){n(this,C).forEach(([t,r])=>{r==null||r(e)})},Be=function(){n(this,U).forEach(([e])=>{e()})},Ye=function(e){n(this,U).forEach(([t,r])=>r(e))},Ve=function(e){l(this,F,"-1"),l(this,I,""),l(this,S,e),l(this,A,!1),l(this,D,!1),l(this,L,void 0)},J.Replica={FULL:"full",DEFAULT:"default"};var Le=J;function ot(s){if(!s.url)throw new Error("Invalid shape options. It must provide the url");if(s.signal&&!(s.signal instanceof AbortSignal))throw new Error("Invalid signal option. It must be an instance of AbortSignal.");if(s.offset!==void 0&&s.offset!=="-1"&&!s.shapeHandle)throw new Error("shapeHandle is required if this isn't an initial fetch (i.e. offset > -1)")}var g,x,H,j,v,P,je,me,ge,Qe=class{constructor(e){u(this,P);u(this,g);u(this,x,new Map);u(this,H,new Map);u(this,j,!1);u(this,v,!1);l(this,g,e),n(this,g).subscribe(p(this,P,je).bind(this),p(this,P,me).bind(this));let t=n(this,g).subscribeOnceToUpToDate(()=>{t()},r=>{throw p(this,P,me).call(this,r),r})}get isUpToDate(){return n(this,g).isUpToDate}get rows(){return this.value.then(e=>Array.from(e.values()))}get currentRows(){return Array.from(this.currentValue.values())}get value(){return new Promise((e,t)=>{if(n(this,g).isUpToDate)e(this.currentValue);else{let r=this.subscribe(({value:i})=>{r(),n(this,v)&&t(n(this,v)),e(i)})}})}get currentValue(){return n(this,x)}get error(){return n(this,v)}lastSyncedAt(){return n(this,g).lastSyncedAt()}lastSynced(){return n(this,g).lastSynced()}isLoading(){return n(this,g).isLoading()}isConnected(){return n(this,g).isConnected()}subscribe(e){let t=Math.random();return n(this,H).set(t,e),()=>{n(this,H).delete(t)}}unsubscribeAll(){n(this,H).clear()}get numSubscribers(){return n(this,H).size}};g=new WeakMap,x=new WeakMap,H=new WeakMap,j=new WeakMap,v=new WeakMap,P=new WeakSet,je=function(e){let t=!1,r=!1,i=!1;e.forEach(o=>{if(ne(o))switch(t=["insert","update","delete"].includes(o.headers.operation),o.headers.operation){case"insert":n(this,x).set(o.key,o.value);break;case"update":n(this,x).set(o.key,T(T({},n(this,x).get(o.key)),o.value));break;case"delete":n(this,x).delete(o.key);break}if(oe(o))switch(o.headers.control){case"up-to-date":r=!0,n(this,j)||(i=!0);break;case"must-refetch":n(this,x).clear(),l(this,v,!1),l(this,j,!1),r=!1,i=!1;break}}),(i||r&&t)&&(l(this,j,!0),p(this,P,ge).call(this))},me=function(e){e instanceof R&&(l(this,v,e),p(this,P,ge).call(this))},ge=function(){n(this,H).forEach(e=>{e({value:this.currentValue,rows:this.currentRows})})};export{ue as BackoffDefaults,R as FetchError,Qe as Shape,Le as ShapeStream,ne as isChangeMessage,oe as isControlMessage};
//# sourceMappingURL=index.browser.mjs.map